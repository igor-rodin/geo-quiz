(()=>{"use strict";document.addEventListener("DOMContentLoaded",(function(){ymaps.ready((function(){var e=new ymaps.Map("map",{center:[55.749693,37.600925],zoom:16,controls:["zoomControl"],behaviors:["drag"]}),a=ymaps.templateLayoutFactory.createClass('<div id="geoReviewBalloon" class="balloon">\n    {% if properties.geoReview %}\n    <div class="reviews balloon__reviews">\n      <ul class="reviews__list">\n      {% for rev in properties.geoReview.placeReviews %}\n        <li class="reviews__item review">\n          <div class="review__header">\n            <span class="review__user">{{rev.userName}}</span>\n            <span class="review__place">{{rev.reviewPlace}}</span>\n            <time datetime={{rev.rawDate}} class="review__date">{{rev.reviewFormatedDate}}</time>\n          </div>\n          <div class="review__text">{{rev.review}}</div>\n        </li>\n      {% endfor %}\n      </ul>\n    </div>\n    {% endif %}\n    <div class="balloon__title">Отзыв:</div>\n    <div class="balloon__row">\n      <input id="geoUserName" class="balloon__input" type="text" placeholder="Укажите ваше имя">\n    </div>\n    <div class="balloon__row">\n      <input id="geoPlace" class="balloon__input" type="text"  placeholder="Укажите место">\n  </div>\n    <div class="balloon__row">\n      <textarea id="geoReview" class="balloon__input balloon__input--textarea"  placeholder="Оставить отзыв"></textarea>\n    </div>\n    <div class="balloon__row balloon__row--ctr">\n      <button id="geoReviewAdd" class="button">Добавить</button>\n    </div>\n  </div>'),t=ymaps.templateLayoutFactory.createClass('<div class="carusel-body"><a id="carusel__link" href=\'#\' class="carusel__link" data-placemarkid="{{ properties.geoReview.Id}}">{{ properties.balloonContentBody }}</a></div>'),o="georeviews",n=[],r=[],i=0,l=localStorage;l.length&&(n=JSON.parse(l.getItem(o)),r=n.map(c));var s=new ymaps.Clusterer({clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!0,clusterBalloonContentLayout:"cluster#balloonCarousel",clusterBalloonItemContentLayout:t,clusterBalloonContentLayoutWidth:200,clusterBalloonContentLayoutHeight:60,clusterBalloonPagerSize:3,clusterBalloonPagerType:"marker"});function c(e){e.Id=i,i++;var t=new ymaps.Placemark(e.coord,{geoReview:e,balloonContentBody:Array.from(new Set(e.placeReviews.map((function(e){return e.reviewPlace})))).join(", ")},{balloonContentLayout:a});return v(t,e.placeReviews),t}function v(e,a){var t=new Set(a.map((function(e){return e.reviewPlace})));t.size>1?(e.options.set({preset:"islands#blueIcon"}),e.properties.set("iconContent",t.size)):e.options.set({preset:"islands#blueDotIcon"}),e.properties.set({balloonContentBody:Array.from(t).join(", ")})}function d(e){return"".concat(e.getDate().toString().padStart(2,0),".").concat((e.getMonth()+1).toString().padStart(2,0),".").concat(e.getFullYear())}function p(e){if(e){var a=e.querySelector("#geoUserName").value.trim(),t=e.querySelector("#geoPlace").value.trim(),o=e.querySelector("#geoReview").value.trim();if(a&&t&&o)return{name:a,place:t,review:o}}}s.add(r),e.geoObjects.add(s),e.options.set({balloonContentLayout:a}),e.events.add("click",(function(a){if(e.balloon.isOpen())e.balloon.close();else{var t=a.get("coords");e.balloon.open(t,{geoReview:""}).then((function(){document.querySelector("#geoReviewAdd").addEventListener("click",(function(a){var i=p(document.querySelector("#geoReviewBalloon")),v=new Date,u=d(v);if(i){var w={coord:t,placeReviews:[{rawDate:v,reviewFormatedDate:u,userName:i.name,reviewPlace:i.place,review:i.review}]},m=c(w);r.push(m),n.push(w),s.add(m),l.setItem(o,JSON.stringify(n,["coord","placeReviews","rawDate","reviewFormatedDate","userName","reviewPlace","review"]))}e.balloon.close()}))}))}})),e.geoObjects.events.add("click",(function(e){var a=e.get("target");a.events.add("balloonopen",(function(e){document.querySelector("#geoReviewAdd").addEventListener("click",(function(e){var t,r,i,s=p(document.querySelector("#geoReviewBalloon")),c=new Date,u=d(c);s&&(r={rawDate:c,reviewFormatedDate:u,userName:s.name,reviewPlace:s.place,review:s.review},(i=(t=a).properties.get("geoReview")).placeReviews.push(r),i.placeReviews.reverse(),t.properties.set({geoReview:i}),v(t,i.placeReviews),l.setItem(o,JSON.stringify(n,["coord","placeReviews","rawDate","reviewFormatedDate","userName","reviewPlace","review"])));a.balloon.close()}))}))})),document.addEventListener("click",(function(e){if("carusel__link"===e.target.id){e.preventDefault();var a=function(e){if(e.length){var a=document.createElement("div");a.classList.add("reviews","reviews--popup");var t=document.createElement("button");t.classList.add("button--popup"),t.textContent="×",a.append(t);var o=document.createElement("ul");return o.classList.add("reviews__list--popup"),a.append(o),e.forEach((function(e){var a,t,n,r,i=document.createElement("li");i.classList.add("reviews__item","review","review--popup"),i.innerHTML=(a=e.userName,t=e.date,n=e.place,r=e.review,'<div class="review__header">\n            <span class="review__user">'.concat(a,'</span>\n            <span class="review__place">').concat(n,'</span>\n            <span class="review__date">').concat(t,'</span>\n          </div>\n          <div class="review__text">').concat(r,"</div>")),o.append(i)})),a}}(r[document.querySelector("#".concat(e.target.id)).dataset.placemarkid].properties.get("geoReview").placeReviews.map((function(e){return{userName:e.userName,date:e.reviewFormatedDate,place:e.reviewPlace,review:e.review}})));document.body.append(a)}else{var t=e.target.closest(".reviews--popup");t&&t.remove()}}))}))}))})();