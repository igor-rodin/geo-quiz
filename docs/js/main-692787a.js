(()=>{"use strict";document.addEventListener("DOMContentLoaded",(function(){ymaps.ready((function(){var e=new ymaps.Map("map",{center:[55.749693,37.600925],zoom:16,controls:["zoomControl"],behaviors:["drag"]}),t=ymaps.templateLayoutFactory.createClass('<div id="geoReviewBalloon" class="balloon">\n    {% if properties.geoReview %}\n    <div class="reviews balloon__reviews">\n      <ul class="reviews__list">\n      {% for rev in properties.geoReview.placeReviews %}\n        <li class="reviews__item review">\n          <div class="review__header">\n            <span class="review__user">{{rev.userName}}</span>\n            <span class="review__place">{{rev.reviewPlace}}</span>\n            <time datetime={{rev.rawDate}} class="review__date">{{rev.reviewFormatedDate}}</time>\n          </div>\n          <div class="review__text">{{rev.review}}</div>\n        </li>\n      {% endfor %}\n      </ul>\n    </div>\n    {% endif %}\n    <div class="balloon__title">Отзыв:</div>\n    <div class="balloon__row">\n      <input id="geoUserName" class="balloon__input" type="text" placeholder="Укажите ваше имя">\n    </div>\n    <div class="balloon__row">\n      <input id="geoPlace" class="balloon__input" type="text"  placeholder="Укажите место">\n  </div>\n    <div class="balloon__row">\n      <textarea id="geoReview" class="balloon__input balloon__input--textarea"  placeholder="Оставить отзыв"></textarea>\n    </div>\n    <div class="balloon__row balloon__row--ctr">\n      <button id="geoReviewAdd" class="button">Добавить</button>\n    </div>\n  </div>'),a=ymaps.templateLayoutFactory.createClass('<div class="carusel-body"><a id="carusel__link" href=\'#\' class="carusel__link" data-placemarkid="{{ properties.geoReview.Id}}">{{ properties.balloonContentBody }}</a></div>'),o="georeviews",n=[],r=[],l=0,i=localStorage;i.length&&i.getItem(o)&&(n=JSON.parse(i.getItem(o)),r=n.map(c));var s=new ymaps.Clusterer({clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!0,clusterBalloonContentLayout:"cluster#balloonCarousel",clusterBalloonItemContentLayout:a,clusterBalloonContentLayoutWidth:200,clusterBalloonContentLayoutHeight:60,clusterBalloonPagerSize:3,clusterBalloonPagerType:"marker"});function c(e){e.Id=l,l++;var a=new ymaps.Placemark(e.coord,{geoReview:e,balloonContentBody:Array.from(new Set(e.placeReviews.map((function(e){return e.reviewPlace})))).join(", ")},{balloonContentLayout:t});return v(a,e.placeReviews),a}function v(e,t){var a=new Set(t.map((function(e){return e.reviewPlace})));a.size>1?(e.options.set({preset:"islands#blueIcon"}),e.properties.set("iconContent",a.size)):e.options.set({preset:"islands#blueDotIcon"}),e.properties.set({balloonContentBody:Array.from(a).join(", ")})}function d(e){return"".concat(e.getDate().toString().padStart(2,0),".").concat((e.getMonth()+1).toString().padStart(2,0),".").concat(e.getFullYear())}function p(e){if(e){var t=e.querySelector("#geoUserName").value.trim(),a=e.querySelector("#geoPlace").value.trim(),o=e.querySelector("#geoReview").value.trim();if(t&&a&&o)return{name:t,place:a,review:o}}}function u(e,t,a){e.setItem(t,JSON.stringify(a,["coord","placeReviews","rawDate","reviewFormatedDate","userName","reviewPlace","review"]))}s.add(r),e.geoObjects.add(s),e.options.set({balloonContentLayout:t}),e.events.add("click",(function(t){if(e.balloon.isOpen())e.balloon.close();else{var a=t.get("coords");e.balloon.open(a,{geoReview:""}).then((function(){document.querySelector("#geoReviewAdd").addEventListener("click",(function(t){var l=p(document.querySelector("#geoReviewBalloon")),v=new Date,w=d(v);if(l){var m={coord:a,placeReviews:[{rawDate:v,reviewFormatedDate:w,userName:l.name,reviewPlace:l.place,review:l.review}]},_=c(m);r.push(_),n.push(m),s.add(_),u(i,o,n)}e.balloon.close()}))}))}})),e.geoObjects.events.add("click",(function(e){var t=e.get("target");t.events.add("balloonopen",(function(e){document.querySelector("#geoReviewAdd").addEventListener("click",(function(e){var a,r,l,s=p(document.querySelector("#geoReviewBalloon")),c=new Date,w=d(c);s&&(r={rawDate:c,reviewFormatedDate:w,userName:s.name,reviewPlace:s.place,review:s.review},(l=(a=t).properties.get("geoReview")).placeReviews.push(r),l.placeReviews.reverse(),a.properties.set({geoReview:l}),v(a,l.placeReviews),u(i,o,n));t.balloon.close()}))}))})),document.addEventListener("click",(function(e){if("carusel__link"===e.target.id){e.preventDefault();var t=function(e){if(e.length){var t=document.createElement("div");t.classList.add("reviews","reviews--popup");var a=document.createElement("button");a.classList.add("button--popup"),a.textContent="×",t.append(a);var o=document.createElement("ul");return o.classList.add("reviews__list--popup"),t.append(o),e.forEach((function(e){var t,a,n,r,l=document.createElement("li");l.classList.add("reviews__item","review","review--popup"),l.innerHTML=(t=e.userName,a=e.date,n=e.place,r=e.review,'<div class="review__header">\n            <span class="review__user">'.concat(t,'</span>\n            <span class="review__place">').concat(n,'</span>\n            <span class="review__date">').concat(a,'</span>\n          </div>\n          <div class="review__text">').concat(r,"</div>")),o.append(l)})),t}}(r[document.querySelector("#".concat(e.target.id)).dataset.placemarkid].properties.get("geoReview").placeReviews.map((function(e){return{userName:e.userName,date:e.reviewFormatedDate,place:e.reviewPlace,review:e.review}})));document.body.append(t)}else{var a=e.target.closest(".reviews--popup");a&&a.remove()}}))}))}))})();